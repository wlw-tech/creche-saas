// ---------- GENERATOR & DATASOURCE ----------
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum Langue {
  fr
  ar
}

enum RoleUtilisateur {
  PARENT
  ENSEIGNANT
  ADMIN
}

enum LienTuteur {
  Mere
  Pere
  Proche
  Tuteur
  Autre
}

enum StatutInscription {
  Candidature
  ListeAttente
  Admis
  Actif
  Inactif
}

enum StatutPresence {
  Present
  Absent
  Justifie
}

enum TypeEntree {
  Repas
  Sieste
  Humeur
  Participation
  Libre
}

enum Audience {
  Parents
  Enseignants
  Tous
}

enum CanalNotification {
  App
  Email
  WhatsApp
}

enum StatutDiffusion {
  AEnvoyer
  Envoye
  Echec
  Annule
}

enum VisibiliteEvenement {
  Global
  Classe
  Prive
}

// ---------- MODELS (MVP mono-centre) ----------
model Classe {
  id             String   @id @default(uuid())
  nom            String
  capacite       Int?
  trancheAge     String?
  active         Boolean  @default(true)
  inscriptions   Inscription[]
  journauxClasse JournalDeClasse[]
  evenements     EvenementCalendrier[]
}

model Utilisateur {
  id        String @id @default(uuid())
  email     String @unique
  telephone String?
  prenom    String
  nom       String
  langue    Langue  @default(fr)
  actif     Boolean @default(true)
  role      RoleUtilisateur
  creeLe    DateTime @default(now())
}

model Famille {
  id                 String @id @default(uuid())
  emailPrincipal     String @unique
  languePreferee     Langue @default(fr)
  adresseFacturation String?
  tuteurs  Tuteur[]
  enfants  Enfant[]
  factures Facture[]
}

model Tuteur {
  id        String @id @default(uuid())
  familleId String
  lien      LienTuteur
  telephone String?
  email     String?
  principal Boolean @default(false)
  famille   Famille @relation(fields: [familleId], references: [id])
}

model Enfant {
  id            String   @id @default(uuid())
  familleId     String
  prenom        String
  nom           String
  dateNaissance DateTime
  genre         String?
  photoUrl      String?
  famille       Famille @relation(fields: [familleId], references: [id])
  inscriptions  Inscription[]
  presences     Presence[]
  journaux      JournalQuotidien[]
  profilSante   ProfilSante?
}

model Inscription {
  id        String   @id @default(uuid())
  enfantId  String
  classeId  String
  statut    StatutInscription @default(Candidature)
  dateDebut DateTime?
  dateFin   DateTime?
  priorite  Int?

  enfant Enfant @relation(fields: [enfantId], references: [id])
  classe Classe @relation(fields: [classeId], references: [id])

  @@index([classeId])
  // Option utile: un enfant n'a qu'1 inscription "Actif" à la fois (non modélisable en unique partiel ici).
}

model Presence {
  id           String   @id @default(uuid())
  enfantId     String
  date         DateTime
  statut       StatutPresence @default(Present)
  arriveeA     DateTime?
  departA      DateTime?
  enregistrePar String? // Utilisateur.id

  enfant Enfant @relation(fields: [enfantId], references: [id])

  @@unique([enfantId, date]) // 1 présence/jour/enfant
  @@index([date])
}

model JournalQuotidien {
  id       String   @id @default(uuid())
  enfantId String
  date     DateTime
  notes    String?
  enfant   Enfant @relation(fields: [enfantId], references: [id])
  entrees  EntreeJournal[]

  @@unique([enfantId, date]) // 1 journal/jour/enfant
  @@index([date])
}

model EntreeJournal {
  id        String   @id @default(uuid())
  journalId String
  type      TypeEntree
  valeur    String
  creePar   String?   // Utilisateur.id (enseignant)
  creeLe    DateTime  @default(now())
  journal   JournalQuotidien @relation(fields: [journalId], references: [id])
}

model JournalDeClasse {
  id        String   @id @default(uuid())
  classeId  String
  date      DateTime
  resume    String?
  creePar   String?   // Utilisateur.id
  creeLe    DateTime  @default(now())
  classe    Classe    @relation(fields: [classeId], references: [id])
  diffusions DiffusionResume[]

  @@unique([classeId, date]) // 1 résumé/jour/classe
  @@index([date])
}

model DiffusionResume {
  id              String   @id @default(uuid())
  journalClasseId String
  tuteurId        String
  canal           CanalNotification
  statut          StatutDiffusion @default(AEnvoyer)
  envoyeLe        DateTime?
  journal         JournalDeClasse @relation(fields: [journalClasseId], references: [id])
}

model ProfilSante {
  id         String @id @default(uuid())
  enfantId   String @unique
  medecin    String?
  notes      String?
  enfant        Enfant @relation(fields: [enfantId], references: [id])
  vaccinations  Vaccination[]
  allergies     Allergie[]
  autorisations AutorisationMedicament[]
}

model Vaccination {
  id            String   @id @default(uuid())
  profilSanteId String
  nom           String
  date          DateTime
  lot           String?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model Allergie {
  id            String   @id @default(uuid())
  profilSanteId String
  nom           String
  severite      String?
  notes         String?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model AutorisationMedicament {
  id            String   @id @default(uuid())
  profilSanteId String
  medicament    String
  dosage        String?
  autorisePar   String?
  signeLe       DateTime?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model Facture {
  id           String   @id @default(uuid())
  familleId    String
  dateEmission DateTime
  dateEcheance DateTime?
  statut       String   @default("Brouillon")
  devise       String   @default("MAD")
  total        Decimal  @default(0)
  famille      Famille @relation(fields: [familleId], references: [id])
  lignes       LigneFacture[]
  paiements    Paiement[]

  @@index([dateEmission])
}

model LigneFacture {
  id           String  @id @default(uuid())
  factureId    String
  description  String
  quantite     Int     @default(1)
  prixUnitaire Decimal @default(0)
  tauxTaxe     Decimal @default(0)
  facture      Facture @relation(fields: [factureId], references: [id])
}

model Paiement {
  id         String  @id @default(uuid())
  factureId  String
  montant    Decimal @default(0)
  statut     String  @default("EnAttente")
  methode    String?
  referenceFournisseur String?
  payeLe     DateTime?
  facture    Facture @relation(fields: [factureId], references: [id])
}

model EvenementCalendrier {
  id         String   @id @default(uuid())
  classeId   String?
  titre      String
  debutA     DateTime
  finA       DateTime
  lieu       String?
  visibilite VisibiliteEvenement @default(Global)
  classe     Classe?  @relation(fields: [classeId], references: [id])

  @@index([debutA])
}
