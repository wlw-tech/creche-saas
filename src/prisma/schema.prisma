// ---------- GENERATOR & DATASOURCE ----------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------- ENUMS ----------
enum Langue {
  fr
  ar
}

enum RoleUtilisateur {
  PARENT
  ENSEIGNANT
  ADMIN
}

enum StatutUtilisateur {
  INVITED
  ACTIVE
  DISABLED
}

enum LienTuteur {
  Mere
  Pere
  Proche
  Tuteur
  Autre
}

enum StatutInscription {
  CANDIDATURE
  EN_COURS
  ACTIF
  REJETEE
}

enum StatutPresence {
  Present
  Absent
  Justifie
}

enum TypeEntree {
  Repas
  Sieste
  Humeur
  Participation
  Libre
}

enum Audience {
  Parents
  Enseignants
  Tous
}

enum CanalNotification {
  App
  Email
  WhatsApp
}

enum StatutDiffusion {
  AEnvoyer
  Envoye
  Echec
  Annule
}

enum VisibiliteEvenement {
  Global
  Classe
  Prive
}

enum StatutMenu {
  Brouillon
  Publie
}

enum NiveauAppetit {
  Excellent
  Bon
  Moyen
  Faible
  Refus
}

enum NiveauHumeur {
  Excellent
  Bon
  Moyen
  Difficile
  Tres_difficile
}

enum NiveauSieste {
  Excellent
  Bon
  Moyen
  Difficile
  Pas_de_sieste
}

enum NiveauParticipation {
  Excellent
  Bon
  Moyen
  Faible
  Absent
}

// ---------- MODELS (MVP mono-centre) ----------
model Classe {
  id             String                @id @default(uuid())
  nom            String
  capacite       Int?
  trancheAge     String?
  active         Boolean               @default(true)
  journauxClasse JournalDeClasse[]
  evenements     EvenementCalendrier[]
  enseignants    EnseignantClasse[]
  dailySummaries ClassDailySummary[]
}

model Utilisateur {
  id           String            @id @default(uuid())
  email        String            @unique
  telephone    String?
  prenom       String
  nom          String
  langue       Langue            @default(fr)
  role         RoleUtilisateur
  statut       StatutUtilisateur @default(INVITED)
  authUserId   String?           @unique // Supabase auth.users.id
  tuteurId     String?           @unique // Lien vers Tuteur si PARENT
  enseignantId String?           @unique // Lien vers Enseignant si TEACHER (futur)
  tempPassword String?           // Mot de passe temporaire pour la première connexion
  inviteLe     DateTime?
  activeLe     DateTime?
  dernierAcces DateTime?
  creeLe       DateTime          @default(now())
  modifieLe    DateTime          @updatedAt

  tuteur Tuteur? @relation(fields: [tuteurId], references: [id])
  enseignant Enseignant? @relation(fields: [enseignantId], references: [id])

  @@index([role])
  @@index([statut])
  @@index([email])
}

model Enseignant {
  id       String             @id @default(uuid())
  utilisateur Utilisateur?
  classes  EnseignantClasse[]
}

model EnseignantClasse {
  id           String   @id @default(uuid())
  enseignantId String
  classeId     String
  dateDebut    DateTime @default(now())
  dateFin      DateTime?

  enseignant Enseignant @relation(fields: [enseignantId], references: [id])
  classe     Classe     @relation(fields: [classeId], references: [id])

  @@unique([enseignantId, classeId])
  @@index([enseignantId])
  @@index([classeId])
}

model Famille {
  id                 String    @id @default(uuid())
  emailPrincipal     String    @unique
  languePreferee     Langue    @default(fr)
  adresseFacturation String?
  tuteurs            Tuteur[]
  enfants            Enfant[]
  factures           Facture[]
  inscriptions       Inscription[]
}

model Tuteur {
  id          String       @id @default(uuid())
  familleId   String
  lien        LienTuteur
  prenom      String?
  nom         String?
  telephone   String?
  email       String?      @unique
  principal   Boolean      @default(false)
  famille     Famille      @relation(fields: [familleId], references: [id])
  utilisateur Utilisateur? // Lien vers compte utilisateur si invité

  @@index([familleId])
  @@index([email])
}

model Enfant {
  id            String             @id @default(uuid())
  familleId     String
  prenom        String
  nom           String
  dateNaissance DateTime
  genre         String?
  photoUrl      String?
  famille       Famille            @relation(fields: [familleId], references: [id])
  inscriptions  Inscription[]
  presences     Presence[]
  journaux      JournalQuotidien[]
  profilSante   ProfilSante?
  dailyResumes  DailyResume[]
}

model Inscription {
  id        String            @id @default(uuid())
  statut    StatutInscription @default(CANDIDATURE)
  payload   Json              @default("{}")  // Données brutes du formulaire pour audit/reprise
  enfantId  String?           // Créé lors de l'acceptation
  familleId String?           // Créé lors de l'acceptation
  notes     String?           // Notes admin (raison rejet, etc.)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @default(now()) @updatedAt

  enfant  Enfant?  @relation(fields: [enfantId], references: [id])
  famille Famille? @relation(fields: [familleId], references: [id])

  @@index([statut])
  @@index([createdAt])
}

model Presence {
  id            String         @id @default(uuid())
  enfantId      String
  date          DateTime
  statut        StatutPresence @default(Present)
  arriveeA      DateTime?
  departA       DateTime?
  enregistrePar String? // Utilisateur.id

  enfant Enfant @relation(fields: [enfantId], references: [id])

  @@unique([enfantId, date]) // 1 présence/jour/enfant
  @@index([date])
}

model JournalQuotidien {
  id       String          @id @default(uuid())
  enfantId String
  date     DateTime
  notes    String?
  enfant   Enfant          @relation(fields: [enfantId], references: [id])
  entrees  EntreeJournal[]

  @@unique([enfantId, date]) // 1 journal/jour/enfant
  @@index([date])
}

model EntreeJournal {
  id        String           @id @default(uuid())
  journalId String
  type      TypeEntree
  valeur    String
  creePar   String? // Utilisateur.id (enseignant)
  creeLe    DateTime         @default(now())
  journal   JournalQuotidien @relation(fields: [journalId], references: [id])
}

model JournalDeClasse {
  id         String            @id @default(uuid())
  classeId   String
  date       DateTime
  resume     String?
  creePar    String? // Utilisateur.id
  creeLe     DateTime          @default(now())
  classe     Classe            @relation(fields: [classeId], references: [id])
  diffusions DiffusionResume[]

  @@unique([classeId, date]) // 1 résumé/jour/classe
  @@index([date])
}

model DiffusionResume {
  id              String            @id @default(uuid())
  journalClasseId String
  tuteurId        String
  canal           CanalNotification
  statut          StatutDiffusion   @default(AEnvoyer)
  envoyeLe        DateTime?
  journal         JournalDeClasse   @relation(fields: [journalClasseId], references: [id])
}

model ProfilSante {
  id            String                   @id @default(uuid())
  enfantId      String                   @unique
  medecin       String?
  notes         String?
  enfant        Enfant                   @relation(fields: [enfantId], references: [id])
  vaccinations  Vaccination[]
  allergies     Allergie[]
  autorisations AutorisationMedicament[]
}

model Vaccination {
  id            String      @id @default(uuid())
  profilSanteId String
  nom           String
  date          DateTime
  lot           String?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model Allergie {
  id            String      @id @default(uuid())
  profilSanteId String
  nom           String
  severite      String?
  notes         String?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model AutorisationMedicament {
  id            String      @id @default(uuid())
  profilSanteId String
  medicament    String
  dosage        String?
  autorisePar   String?
  signeLe       DateTime?
  profilSante   ProfilSante @relation(fields: [profilSanteId], references: [id])
}

model Facture {
  id           String         @id @default(uuid())
  familleId    String
  dateEmission DateTime
  dateEcheance DateTime?
  statut       String         @default("Brouillon")
  devise       String         @default("MAD")
  total        Decimal        @default(0)
  famille      Famille        @relation(fields: [familleId], references: [id])
  lignes       LigneFacture[]
  paiements    Paiement[]

  @@index([dateEmission])
}

model LigneFacture {
  id           String  @id @default(uuid())
  factureId    String
  description  String
  quantite     Int     @default(1)
  prixUnitaire Decimal @default(0)
  tauxTaxe     Decimal @default(0)
  facture      Facture @relation(fields: [factureId], references: [id])
}

model Paiement {
  id                   String    @id @default(uuid())
  factureId            String
  montant              Decimal   @default(0)
  statut               String    @default("EnAttente")
  methode              String?
  referenceFournisseur String?
  payeLe               DateTime?
  facture              Facture   @relation(fields: [factureId], references: [id])
}

model EvenementCalendrier {
  id         String              @id @default(uuid())
  classeId   String?
  titre      String
  debutA     DateTime
  finA       DateTime
  lieu       String?
  visibilite VisibiliteEvenement @default(Global)
  classe     Classe?             @relation(fields: [classeId], references: [id])

  @@index([debutA])
}

model Menu {
  id           String       @id @default(uuid())
  date         DateTime     @unique // Une date = un menu unique
  entree       String?      // Plat d'entrée
  plat         String?      // Plat principal
  dessert      String?      // Dessert
  statut       StatutMenu   @default(Brouillon) // Brouillon ou Publié
  allergenes   MenuAllergen[] // Liste des allergènes
  creePar      String?      // Utilisateur.id (admin)
  creeLe       DateTime     @default(now())
  modifieLe    DateTime     @updatedAt
  publieLe     DateTime?    // Date de publication

  @@index([date])
  @@index([statut])
}

model MenuAllergen {
  id       String @id @default(uuid())
  menuId   String
  allergen String // Nom de l'allergène (ex: "Arachides", "Gluten", "Lait")
  menu     Menu   @relation(fields: [menuId], references: [id], onDelete: Cascade)

  @@unique([menuId, allergen])
  @@index([menuId])
}

// ---------- DAILY RESUME (Résumé quotidien des enfants) ----------
model DailyResume {
  id             String                    @id @default(uuid())
  enfantId       String
  enfant         Enfant                    @relation(fields: [enfantId], references: [id], onDelete: Cascade)
  date           DateTime                  // Date du résumé
  appetit        NiveauAppetit?            // Niveau d'appétit
  humeur         NiveauHumeur?             // Humeur de l'enfant
  sieste         NiveauSieste?             // Qualité de la sieste
  participation  NiveauParticipation?      // Participation aux activités
  observations   DailyResumeObservation[]  // Observations détaillées
  creePar        String?                   // Utilisateur.id (enseignant)
  creeLe         DateTime                  @default(now())
  modifieLe      DateTime                  @updatedAt

  @@unique([enfantId, date])
  @@index([date])
  @@index([enfantId])
}

model DailyResumeObservation {
  id            String       @id @default(uuid())
  dailyResumeId String
  dailyResume   DailyResume  @relation(fields: [dailyResumeId], references: [id], onDelete: Cascade)
  observation   String       // Texte de l'observation
  creeLe        DateTime     @default(now())

  @@index([dailyResumeId])
}

// Résumé collectif de la journée par classe
model ClassDailySummary {
  id            String    @id @default(uuid())
  classeId      String
  classe        Classe    @relation(fields: [classeId], references: [id], onDelete: Cascade)
  date          DateTime  // Date du résumé
  activites     String    // Activités du jour
  apprentissages String   // Apprentissages du jour
  humeurGroupe  String    // Humeur générale du groupe
  observations  String?   // Observations supplémentaires
  statut        StatutResume @default(Brouillon) // Brouillon ou Publie
  creePar       String?   // Utilisateur.id (enseignant)
  creeLe        DateTime  @default(now())
  modifieLe     DateTime  @updatedAt
  publieLe      DateTime? // Date de publication

  @@unique([classeId, date])
  @@index([date])
  @@index([classeId])
}

enum StatutResume {
  Brouillon
  Publie
}
